name: Forecast Approval Trigger

on:
  push:
    branches:
      - 'release**'     # Trigger when PR is merged to any release* branch

jobs:
  trigger-endpoint:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the PR merge commit
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Identify changed files in the merge commit
      - name: Get changed files
        id: changes
        run: |
          git fetch --depth=2 origin ${{ github.ref }}
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          METADATA_FILE=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep 'forecast_metadata.json$' | head -n 1)
          echo "changed=$METADATA_FILE" >> $GITHUB_OUTPUT
          echo "Changed files: $METADATA_FILE"

      # Step 3: Read forecast_metadata.json if changed
      - name: Extract metadata
        id: metadata
        run: |
          # Find the first changed file that ends with forecast_metadata.json
          # METADATA_FILE=$(echo "${{ steps.changes.outputs.changed }}" | tr ' ' '\n' | grep 'forecast_metadata.json$' | head -n 1)
          METADATA_FILE="${{ steps.changes.outputs.changed }}"
          if [ -z "$METADATA_FILE" ]; then
            echo "No forecast_metadata.json file found in the changed files. Exiting."
            exit 0
          fi

          echo "Metadata file found at: $METADATA_FILE"
          echo "Metadata file changed. Extracting values..."
          MODEL_VERSION=$(jq -r '.modelContainerVersion' $METADATA_FILE)
          ANALYST_BRANCH=$(jq -r '.branchName' $METADATA_FILE)

          # Split into array
          IFS='/' read -ra PARTS <<< "$ANALYST_BRANCH"
          FORECAST=$(IFS='/'; echo "${PARTS[*]:1}")

          echo "model_version=$MODEL_VERSION" >> $GITHUB_OUTPUT
          echo "analyst_branch=$ANALYST_BRANCH" >> $GITHUB_OUTPUT
          echo "forecast=$FORECAST" >> $GITHUB_OUTPUT
          echo "model_version=$MODEL_VERSION"
          echo "analyst_branch=$ANALYST_BRANCH"
          
      
      # Step 4: Authenticate and get bearer token
      - name: Get Bearer Token
        id: auth
        run: |
          LOGIN_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"${{ secrets.API_USERNAME }}\",
              \"password\": \"${{ secrets.API_PASSWORD }}\"
            }" \
            "${{ secrets.API_URL }}/login")

          echo "Login Response: $LOGIN_RESPONSE"

          TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.access_token // .token // .jwt // empty')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to obtain bearer token"
            exit 1
          fi

          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      # Step 5: Call the approval API
      - name: Call Approval API
        id: api_call
        run: |
          JSON_BODY=$(jq -n \
            --arg forecast "country/ca" \
            --arg branch_name "${{ steps.metadata.outputs.analyst_branch }}" \
            --arg invoke_route "forecast_approval" \
            --arg model "all" \
            --arg merge_into_main "True" \
            --arg model_version "" \
            --arg run_dq "True" \
            '{
              forecast: $forecast,
              branch_name: $branch_name,
              invoke_route: $invoke_route,
              model: $model,
              merge_into_main: $merge_into_main,
              model_version: $model_version,
              run_dq: $run_dq
            }'
          )

          echo "Request JSON:"
          echo "$JSON_BODY"

          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.token }}" \
            -d "$JSON_BODY" \
            "${{ secrets.API_URL }}")

          echo "API HTTP Status: $RESPONSE"
          echo "API Response: $(cat response.txt)"

          if [ "$RESPONSE" != "200" ]; then
            echo "API call failed"
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi