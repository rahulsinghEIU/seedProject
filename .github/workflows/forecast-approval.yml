name: Forecast Approval Trigger

on:
  push:
    branches:
      - 'release**'     # Trigger when PR is merged to any release* branch

jobs:
  trigger-endpoint:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the PR merge commit
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Identify changed files in the merge commit
      - name: Get changed files
        id: changes
        run: |
          git fetch --depth=2 origin ${{ github.ref }}
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          METADATA_FILE=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep 'forecast_metadata.json$' | head -n 1)
          echo "changed=$METADATA_FILE" >> $GITHUB_OUTPUT
          echo "Changed files: $METADATA_FILE"

      # Step 3: Read forecast_metadata.json if changed
      - name: Extract metadata
        id: metadata
        run: |
          # Find the first changed forecast_metadata.json. Ensures there was actually an approval.

          METADATA_FILE="${{ steps.changes.outputs.changed }}"
          if [ -z "$METADATA_FILE" ]; then
            echo "No forecast_metadata.json file found in the changed files. Exiting."
            exit 0
          fi

          echo "Metadata file found at: $METADATA_FILE"
          echo "Metadata file changed. Extracting values..."

          MODEL_VERSION=$(jq -r '.modelContainerVersion' $METADATA_FILE)
          ANALYST_BRANCH=$(jq -r '.branchName' $METADATA_FILE)
          IFS='/' read -ra PARTS <<< "$ANALYST_BRANCH"
          FORECAST=$(IFS='/'; echo "${PARTS[*]:1}")

          echo "model_version=$MODEL_VERSION" >> $GITHUB_OUTPUT
          echo "analyst_branch=$ANALYST_BRANCH" >> $GITHUB_OUTPUT
          echo "forecast=$FORECAST" >> $GITHUB_OUTPUT

      # Step 4: Authenticate and get bearer token
      - name: Get Bearer Token + Call API
        id: call_api
        run: |
          # ------------------------------------
          # 1. Prepare inputs
          # ------------------------------------
          REPO_NAME="${{ github.event.repository.name }}"
          BASE_URL="${{ secrets.API_URL }}"

          FORECAST="${{ steps.metadata.outputs.forecast }}"
          BRANCH_NAME="${{ steps.metadata.outputs.analyst_branch }}"
          MODEL_VERSION="${{ steps.metadata.outputs.model_version }}"

          echo "Repo: $REPO_NAME"
          echo "Forecast: $FORECAST"
          echo "Branch name: $BRANCH_NAME"
          echo "Model version: $MODEL_VERSION"

          # ------------------------------------
          # 2. Environment based overrides
          # ------------------------------------
          if [[ "$REPO_NAME" == *"-dev" ]]; then
            API_URL="${BASE_URL/\{env\}/-dev}"
            MODEL_VERSION=""
            BRANCH_NAME="main"
          else
            API_URL="${BASE_URL/\{env\}/}"
          fi

          echo "Final API URL: $API_URL"
          echo "Final MODEL_VERSION: $MODEL_VERSION"
          echo "Final BRANCH_NAME: $BRANCH_NAME"
          echo "Final FORECAST: $FORECAST"

          # ------------------------------------
          # 3. Get bearer token
          # ------------------------------------
          LOGIN_RESPONSE=$(curl -s -X POST \
            -H "accept: application/json" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=${{ secrets.API_USERNAME }}&password=${{ secrets.API_PASSWORD }}" \
            "$API_URL/v1/data/login")

          echo "Login Response: $LOGIN_RESPONSE"

          TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.access_token // .token // .jwt // empty')

          if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
            echo "Failed to obtain bearer token"
            exit 1
          fi

          echo "Token acquired."

          # ------------------------------------
          # 4. Build payload & send approval
          # ------------------------------------
          JSON_BODY=$(jq -n \
            --arg forecast "$FORECAST" \
            --arg branch_name "$BRANCH_NAME" \
            --arg invoke_route "forecast_approval" \
            --arg model "all" \
            --arg merge_into_main "True" \
            --arg model_version "$MODEL_VERSION" \
            --arg run_dq "True" \
            --arg residual_file_path "" \
            '{
              forecast: $forecast,
              branch_name: $branch_name,
              invoke_route: $invoke_route,
              model: $model,
              merge_into_main: $merge_into_main,
              model_version: $model_version,
              run_dq: $run_dq,
              residual_file_path: $residual_file_path
            }'
          )

          echo "Request JSON:"
          echo "$JSON_BODY" | jq .

          # ------------------------------------
          # 5. Call forecast approval API
          # ------------------------------------
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d "$JSON_BODY" \
            "$API_URL/v1/model/invoke")

          echo "HTTP Status: $RESPONSE"
          echo "API Response: $(cat response.txt)"

          if [[ "$RESPONSE" != "200" ]]; then
            echo "API call failed"
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
